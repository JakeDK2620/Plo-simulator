import streamlit as st
import random
from itertools import combinations
from treys import Card, Evaluator

evaluator = Evaluator()

suits = ['s', 'h', 'd', 'c']
ranks = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A']
deck = [r + s for r in ranks for s in suits]

def to_treys(cards):
    return [Card.new(c) for c in cards]

def plo_best_hand(hand, board):
    best = 7463
    for hand_combo in combinations(hand, 2):
        for board_combo in combinations(board, 3):
            full_hand = list(hand_combo + board_combo)
            score = evaluator.evaluate(list(hand_combo), list(board_combo))
            if score < best:
                best = score
    return best

def get_random_hand(exclude):
    available = list(set(deck) - set(exclude))
    return random.sample(available, 4)

def get_random_board(exclude, n):
    available = list(set(deck) - set(exclude))
    return random.sample(available, n)

def simulate(hero_hand, opponent_hands, board_cards, street, num_sims, randomize_opps):
    wins = ties = 0
    hero_treys = to_treys(hero_hand)
    board_base = to_treys(board_cards)
    needed = {'preflop': 5, 'flop': 2, 'turn': 1, 'river': 0}[street]

    for _ in range(num_sims):
        used = set(hero_hand + board_cards)
        sim_board = board_base + to_treys(get_random_board(used, needed))
        used.update(Card.int_to_str(c) for c in sim_board)

        current_opps = []
        for opp in opponent_hands:
            if randomize_opps or len(opp) != 4:
                hand = get_random_hand(used)
                used.update(hand)
                current_opps.append(to_treys(hand))
            else:
                current_opps.append(to_treys(opp))

        hero_score = plo_best_hand(hero_treys, sim_board)
        opp_scores = [plo_best_hand(opp, sim_board) for opp in current_opps]

        if all(hero_score < s for s in opp_scores):
            wins += 1
        elif any(hero_score == s for s in opp_scores):
            ties += 1

    return wins, ties, num_sims

# GUI
st.title("Pot Limit Omaha Simulator")

num_players = st.selectbox("Antal spillere (inkl. dig)", list(range(2, 9)))
num_opponents = num_players - 1

hero_hand = st.multiselect("Vælg Hero's hånd (4 kort)", options=deck, max_selections=4)

opponent_hands = []
for i in range(num_opponents):
    opponent_hands.append(
        st.multiselect(f"Modstander {i+1} hånd (4 kort – valgfri)", options=deck, max_selections=4, key=f"opp_{i}")
    )

board = st.multiselect("Board-kort (vælg op til 5)", options=deck, max_selections=5)

randomize_opps = st.checkbox("Tilfældige modstanderkort", value=True)
street = st.selectbox("Simuler efter street", ["preflop", "flop", "turn", "river"])
num_sims = st.slider("Antal simuleringer", 1, 20000, 1000)

if st.button("Kør simulering"):
    if len(hero_hand) != 4:
        st.error("Hero skal have præcis 4 kort.")
    else:
        try:
            wins, ties, total = simulate(hero_hand, opponent_hands, board, street, num_sims, randomize_opps)
            st.success(f"Hero vinder {wins}/{total} ({wins/total*100:.2f}%) – Tie: {ties/total*100:.2f}%")
        except Exception as e:
            st.error(f"Fejl i simulering: {e}")